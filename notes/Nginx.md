https://github.com/nginxinc/nginx-basics-workshops/blob/master/OSS/labs/lab1/media/lab1_nginx-architecture.png

Dissecting the image:
- Nginx seems to have a master process that:
	- controls the workers;
	- reads and validates config files before using them;
	- writes to error and logging files;
	- performs other NGINX and Linux management tasks;
	- is considered the Control plane process (workers are data plane);
- Through Admin/APM APIs you can manage and monitor the workers.
- Config files:
	- .conf -> defines nginx settings, server blocks, logging, gzip
	- .stats -> generated by a monitoring tool, doesn't seem to be native to nginx;
	- .log -> recording access logs and error logs, usually in `/var/log/nginx/`
	- .pid -> pid of the main Nginx process; default in `/run/nginx.pid` or `/var/run/nginx.pid`;
- Serving static/temp files through asynchronous I/O.
- Cache loader process = runs on startup, loads metadata such as keys, sizes, timestamps into memory; exits after it finishes loading
- Cache manager process = runs continuously in the background, cleans up expired cache items, enforces max_size;

Nginx uses a **Shared memory model**, common elements are equally accessed by all workers.

Status endpoint: `curl http://localhost:9000/basic_status`

### Useful commands and locations
`/etc/nginx` -> contains Nginx config files

`apk info -vv | grep nginx` -> what nginx packages are installed;
`ps aux | grep nginx` -> what nginx packages are running;
`netstat -alpn` -> what ports does Nginx use?
`nginx -h` -> help, most useful commands
`nginx -t` -> test current configuration;
`docker logs nginx-oss` -> general see logs Docker
`nginx -s reload` -> reload server after you made some changes to conf

## Nginx basics workshop
### Lab 2
Very simple http block:
```nginx
http {
    server {
        listen 80;
        server_name www.example.com;
        
        location /application1 {
            index index.html;
        }
    }
}
```
`http{}` = HTTP context aka how to handle HTTP traffic; Alternatives: `events, stream, mail`. `events, http` most common;
`server{}` = server block, defines one "virtual host" = set of rules for handling requests to a particular domain or IP;
`listen 80` -> pretty clear;
`server_name` -> domain name that the server block will respond to;
`location /application1` -> defines a route I guess? + what to serve (`index.html`).

Example events block:
```nginx
events {
	worker_connections 1024;
	multi_accept on;
	use epoll;
}
```
- `worker_connections` = how many simultaneous connections each worker process can handle;
- `multi-accept on;` = when true, each worker process will accept as many new connections as possible in one go instead of one at a time;
- `use epoll` = which I/O event method to use;

Some typical Nginx commands:
`nginx -v` = version details
`nginx -s quit` = graceful shutdown
`nginx -s stop` = terminates all Nginx processes (presumably ungracefully?)
`nginx -s reload` = reloads Nginx with new configuration
`nginx -t` = test configuration syntax + files
`nginx -T` = print current running configurations

By default, Nginx Master will create a Worker process for every CPU core.

Nginx configs:
- Contexts (as above, `http`, `events`, etc);
- Includes = additional files that Nginx should use for configuration;
- Directives = simple or block;

Another example:
```nginx
server {
    listen       80;
    server_name  localhost;         

    access_log  /var/log/nginx/localhost.access.log  main;

    location / {                         
        root   /usr/share/nginx/html;
        index  index.html index.htm;
    }

    location /images/ {
        root   /data;
    }
)
```

Contexts + block follow the construction of an HTTP URL:
- `main` + `events` = nginx startup parameters;
- `http` = high level http params: logging, data types, timers, include files;
- `server` = virtual server params: listen port, hostname, access log, include files;
- `location` = URL path + object type;
e.g: `http://www.example.com:8080/images/smile.png` -> `schema://hostname:port/uri/object.type`;

Example Linux file structure:
```bash
/etc # tree nginx
nginx                             
├── conf.d                        # http contexts
│   ├── cafe.example.com.conf     # server and location contexts for each website
│   ├── cars.example.com.conf
│   ├── default.conf
│   ├── stub_status.conf
│   ├── www.example.com.conf
│   └── www2.example.com.conf
├── includes                      # Include other shared config files
├── fastcgi.conf
├── fastcgi_params
├── mime.types
├── modules -> /usr/lib/nginx/modules
├── nginx.conf                    # main and events contexts
├── scgi_params
└── uwsgi_params
```
Notes on host headers + host-based routing:
- Can use same IP + port for multiple hostnames -> re-route by selecting the correct host.
- `default_server` = last resort, when none of the hostnames match;
- Remember `server_name directive`

Security: `ssl_certificate`, `ssl_certificate_key` + can add security headers and import them.

If using TLS v1.3, requests which use v1.2, v.1.1 will fail.

Stub status module: https://nginx.org/en/docs/http/ngx_http_stub_status_module.html

### Reverse proxy considerations
Can add logs for each backend, `upstream_X`.

`proxy_headers` -> so you don't lose info in the request or response;
Additional info in Nginx variables.
Term to remember: `adding custom HTTP headers`
e.g:
```nginx
# client address in binary format
proxy_set_header X-Real-IP $remote_addr;

# X-Forwarded-For client request header 
proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

# request scheme, “http” or “https”
proxy_set_header X-Forwarded-Proto $scheme;
```

HTTP/1.1 -> new TCP conn for every request. 
HTTP/1.1 for proxied requests -> re-use TCP conns for multiple requests (HTTP keepalives / pipelining)

Term to remember: `keepalives`

### Nginx persistence / affinity
Once you map a client with a server via a load balancer, you might want to keep choosing that server for that particular client.

`ip_hash`



